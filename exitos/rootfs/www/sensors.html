<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Control energètic eXIT</title>
    <link rel="stylesheet" href="resources/mainStyle.css">
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">

    <!-- llibreria d'icontes per al navbar-->
    <script src="https://kit.fontawesome.com/d259d5cefc.js" crossorigin="anonymous"></script>
</head>

<body>
    <main>
        <!--    NAVBAR     -->
        % rebase('./www/base.html', title='Exitos')


        <div class="devices-table-container" id="mainContainer">
            <h2>Configuració de Dispositius i Entitats</h2>
            <p class="lead">Selecciona quins dispositius i entitats vols guardar, i assigna el tipus de cada entitat.</p>

            <div class="button-div">
                <div class="switch-wrap">
                    <span class="muted">Tots els dispositius</span>
                    <div id="onlySavedSwitch" class="switch" title="Mostra només dispositius guardats">
                        <div class="knob"></div>
                    </div>
                    <span class="muted">Només guardats</span>
                </div>
            </div>
            <div class="button-div">

                <button class="btn" id="saveBtn"><i class="fa-regular fa-floppy-disk"></i> Guardar canvis</button>
                <button class="btn secondary" id="selectAllBtn"><i class="fa-regular fa-square-check"></i> Seleccionar tots</button>
                <button class="btn secondary" id="deselectAllBtn"><i class="fa-regular fa-square-minus"></i> Desseleccionar tots</button>
            </div>


            <form id="devices-form">
                <table id="devices-table">
                    <thead>
                        <tr>
                            <th style="width: 4px;">Guardar</th>
                            <th>Nom del Dispositiu</th>
                        </tr>
                    </thead>
                    <tbody id="devices-table-body"></tbody>
                </table>
            </form>

            <div class="spacer"></div>
            <div id="saveResult" class="muted"></div>
        </div>

        <button id = "back-to-top-btn" onclick="ScrollToTop()" class="fa-solid fa-circle-up"></button>

    </main>
</body>

<script>
    /* === PARÀMETRES I HELPERS === */
     const ENTITY_TYPES = ["No especificat", "Energy Storage", "Generator", "Consumer"];
     let onlySaved = false;
     let devices = {};

     const devicesTableBody = document.getElementById('devices-table-body');
     const onlySavedSwitch = document.getElementById('onlySavedSwitch');
     const saveBtn = document.getElementById('saveBtn');
     const selectAllBtn = document.getElementById('selectAllBtn');
     const deselectAllBtn = document.getElementById('deselectAllBtn');
     const saveResult = document.getElementById('saveResult');

    /**
     * Carrega dispositius amb un fetch i els renderitza en pantalla.
     * Assumim que fetch retorna format { "<device name>": [ {entity_id, friendly_name}, ... ], ... }
     */
     async function LoadDevices(){
         try{
             const res = await fetch('get_sensors');
             const json = await res.json();

             const raw = json.devices || json;

             devices = {};

             raw.sort((a,b) => a.device_name
                 .localeCompare(b.device_name, 'ca', {sensitivity:'base'}))
                 .forEach(device => {
                 const deviceName = device.device_name;
                 const ents = device.entities || [];

                 devices[deviceName] = ents.map(e => {
                     return {
                         entity_id: e.entity_id || e.id || (typeof e === 'string' ? e: ''),
                         friendly_name: e.entity_name || e.name || (e.entity_id || ''),
                         save: e.save ? 1: 0,
                         type: e.type || "No especificat"
                     };
                 });
             });
             RenderDevices();
         }catch(err){
             console.error('Error carregant dispositius: ', err);
             saveResult.textContent = "Error carregant dispositius"
         }
     }

    /**
     * Renderitza creant una fila per a cada dispositiu i una subtaula per les entitats.
     */
    function RenderDevices(){
         devicesTableBody.innerHTML = '';
         const deviceNames = Object.keys(devices);

         deviceNames.forEach((deviceName, idx) => {
             const entities = devices[deviceName];
             const anySaved = entities.some(e => e.save === 1);
             if(onlySaved && !anySaved) return;

            CreateDeviceRow(idx+1, deviceName, entities);
         });
    }

    /**
     * Crea una fila per a cada dispositiu + files per a la subtaula d'entitats
     */
    function CreateDeviceRow(index, deviceName, entities){
        const row = document.createElement('tr');
        row.className = 'device-row';

        //CHECKBOX
        const tdCheckbox = document.createElement('td');
        const devCheckbox = document.createElement('input');
        devCheckbox.type = 'checkbox';
        devCheckbox.className = 'device-checkbox';
        devCheckbox.checked = entities.every(e => e.save === 1);
        tdCheckbox.appendChild(devCheckbox);

        //NAME
        const tdName = document.createElement('td');
        const nameWrap = document.createElement('div');
        nameWrap.className = 'device-name';
        const tri = document.createElement('span');
        tri.className = 'tri';
        tri.textContent = '▶';
        const nameText = document.createElement('span');
        nameText.textContent = deviceName;
        nameWrap.appendChild(tri);
        nameWrap.appendChild(nameText);
        tdName.appendChild(nameWrap);

        //APPEND CHILDS
        row.appendChild(tdCheckbox);
        row.appendChild(tdName);

        // fila subtaula
        const subRow = document.createElement('tr');
        subRow.className = 'sub-row';
        subRow.style.display = 'none';

        const subCell = document.createElement('td');
        subCell.colSpan = 3;

        //subtaula d'entitats
        const subTable = document.createElement('table');
        subTable.className = 'entities-table';


        //ordenar entitats per friendly_name
        const sortedEntities = entities.slice().sort((a,b) => (a.friendly_name || a.entity_id).localeCompare(b.friendly_name || b.entity_id, 'ca', {sensitivity: 'base'}));
        sortedEntities.forEach((ent, entIdx) => {
            const entRow = CreateEntityRow(ent, entIdx, devCheckbox);
            subTable.appendChild(entRow);
        })

        // subTable.appendChild(tbody);
        subCell.appendChild(subTable);
        subRow.appendChild(subCell);

        // CREAR INTERACCIONS
        nameWrap.addEventListener('click', () => {
            const isOpen = subRow.style.display !== 'none';
            subRow.style.display = isOpen ? 'none' : 'table-row';
            nameWrap.classList.toggle('expanded', !isOpen);
        });

        // Quan canvii checkbox de dispositiu: marcar/desmarcar totes les entitats
        devCheckbox.addEventListener('change', () => {
            const check = devCheckbox.checked;
            const entityCheckboxes = subRow.querySelectorAll('.entity-checkbox');
            entityCheckboxes.forEach(cb => { cb.checked = check; cb.dispatchEvent(new Event('change')); });
            // Actualitzar estats visuals
            if (check) {
                // si l'usuari decideix marcar el dispositiu però la subtaula està oculta, l'obrim per feedback
                subRow.style.display = 'table-row';
                nameWrap.classList.add('expanded');
            }
        });

        devicesTableBody.appendChild(row);
        devicesTableBody.appendChild(subRow);
    }

    /**
     * Crea la fila per a cada entitat
     */
    function CreateEntityRow(ent, entIdx, devCheckbox){
        const entRow = document.createElement('tr');
        entRow.className = 'entity-row';

        // CHECKBOX ENTITAT
        const tdEntCheck = document.createElement('td');
        const entCheck = document.createElement('input');
        entCheck.type = 'checkbox';
        entCheck.className = 'entity-checkbox';
        entCheck.checked = !!ent.save;
        entCheck.addEventListener("change", () => ent.save = entCheck.checked);
        tdEntCheck.appendChild(entCheck);

        // NOM ENTITAT
        const tdEntName = document.createElement('td');
        tdEntName.textContent = ent.friendly_name;


        //SELECT TIPUS ENTITAT
        const tdEntType = document.createElement('td');
        const select = document.createElement('select');
        select.className = 'entity-type-select';
        ENTITY_TYPES.forEach(t => {
            const opt = new Option(t, t);
            if(t === ent.type) opt.selected = true;
            select.appendChild(opt);
        });

        select.disabled = !entCheck.checked;
        tdEntType.appendChild(select);

        //INTERACCIONS
        // Quan canvii checkbox d'entitat: habilita/deshabilita select i actualitza objecte local
        entCheck.addEventListener('change', () => {
          select.disabled = !entCheck.checked;
          // si queda desmarcada i el dispositiu estava completament marcat, actualitzem checkbox del dispositiu
          devCheckbox.checked = GetAllEntityCheckboxes(entRow.parentElement).every(cb => cb.checked);
        });

        // Quan canvii select, actualitzem l'objecte local
        select.addEventListener('change', () => {
          ent.type = select.value;

        });

        entRow.appendChild(tdEntCheck);
        entRow.appendChild(tdEntName);
        // entRow.appendChild(tdEntId);
        entRow.appendChild(tdEntType);

        return entRow;
    }

    function GetAllEntityCheckboxes(tbodyElem){
        if (!tbodyElem) return [];
        return Array.from(tbodyElem.querySelectorAll('.entity-checkbox'));
    }

    /**
     * Marca o desmarca totes les entitats i dispositius
     */
    function ToggleAll(select){
        document.querySelectorAll('.device-checkbox').forEach(checkbox => {
            checkbox.checked = select;
            checkbox.dispatchEvent(new Event('change'));
        });
        document.querySelectorAll('.entity-checkbox').forEach(checkbox => {
            checkbox.checked = select;
            checkbox.dispatchEvent(new Event('change'));
        })
    }

    /**
     * Alterna la vista entre tots els dispositius o només aquells guardats.
     */
    function ToggleOnlySaved(){
        onlySaved = !onlySaved;
        onlySavedSwitch.classList.toggle('on', onlySaved);
        RenderDevices();
    }

    /**
     * Envia les dades seleccionades al backend per a guardar-les a la base de dades
     */
    async function SaveDevices(){
        const selectedEntities = [];

        Object.keys(devices).forEach(deviceName => {
            devices[deviceName].forEach(ent => {
                if(ent.save){
                    selectedEntities.push({
                        device:deviceName,
                        entityId:ent.entity_id,
                        friendly_name: ent.friendly_name,
                        type: ent.type,
                    });
                }
            })
        });


        const res = await fetch('update_sensors',{
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(selectedEntities),
        });

        const result = await res.json();
        if (result.status === 'ok') {
          await LoadDevices();
        }
        else {
          console.error("ERROR", result.status);
        }
    }

    /**
     * Petita funcionalitat per retornar la pàgina a la part superior en premer el botó
     */
    function ScrollToTop(){
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    //EVENTS I INICI
    selectAllBtn.addEventListener('click', (e) => { e.preventDefault(); ToggleAll(true); });
    deselectAllBtn.addEventListener('click', (e) => { e.preventDefault(); ToggleAll(false); });
    onlySavedSwitch.addEventListener('click', ToggleOnlySaved);
    saveBtn.addEventListener('click', (e) => { e.preventDefault(); SaveDevices(); });

     window.onscroll = function () {
        let button = document.getElementById("back-to-top-btn");
        if (document.documentElement.scrollTop > 300) {
            button.classList.add("show");
        } else {
            button.classList.remove("show");
        }
    };

    LoadDevices();
</script>

</html>