<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Control energètic eXIT</title>
    <link rel="stylesheet" href="resources/mainStyle.css">
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">
    <!--    <link rel="stylesheet" href="../resources/mainStyle.css">-->

    <!-- llibreria d'icontes per al navbar-->
    <script src="https://kit.fontawesome.com/d259d5cefc.js" crossorigin="anonymous"></script>
    <script src="https://cdn.plot.ly/plotly-3.1.0.min.js" charset="utf-8"></script>

</head>

<body>
<!--    NAVBAR     -->
% rebase('./www/base.html', title='Exitos')

<!--    HERO    -->
<div class="hero">
    <h1>Benvingut/da a eXiT Control Energètic</h1>
    <p>Gestiona, visualitza i optimitza la teva energia</p>
</div>


<!--    INFO CARDS    -->
<div class="container">
    <!--   SENSORS    -->
    <div class="info-cards-container">
        <a href="./sensors" class="info-card">
            <i class="fa-solid fa-square-check"></i>
            <h3>Sensors</h3>
            <p>Selecciona els sensors dels quals vols monitoritzar i recollir dades.</p>
        </a>
    <!--     DATABASE       -->
        <a href="./databaseView" class="info-card">
                <i class="fa-solid fa-database"></i>
                <h3>Base de Dades</h3>
                <p>Visualitza les dades en un rang de temps personalitzat.</p>
        </a>
        <!--   MODEL     -->
        <a href="./model" class="info-card">
            <i class="fa-solid fa-brain"></i>
            <h3>Crear Model</h3>
            <p>Entrena models predictius d'ús energètic per sensors específics i realitza les prediccions amb aquests.</p>
        </a>
        <!--   CONFIG   -->
        <a href="./config_page" class="info-card">
            <i class="fa-solid fa-user-gear"></i>
            <h3>Configuració</h3>
            <p>Ajusta paràmetres d'usuari. Uneix-te o abandona una comunitat.</p>
        </a>
    </div>

</div>

<!--    PLANIFICACIÓ SONNEN -->
<div class="scheduler-container">
    <h2>Horaris Configurats</h2>
    <div id="scheduler-grid" class="scheduler-grid"> <!--AQUI ES POSEN ELS FORECASTS--> </div>
</div>


<!--    FORECASTS     -->
<div class="forecasts-container">
    <h2>Forecastings Guardats</h2>
    <div id="forecast-grid" class="forecast-grid"> <!--AQUI ES POSEN ELS FORECASTS--> </div>
</div>




</body>

<script>
    function onLoadPage() {
        const sensors_list = {{!active_sensors_list}};
        const parent_div_forecast = document.getElementById("forecast-grid");
        const parent_div_scheduler = document.getElementById("scheduler-grid")
        sensors_list.forEach((sensor_id) => {
            // const fixed_name = sensor_id.replace("sensor.", '')
            const fixed_name = sensor_id.replace(".pkl", "")

            fetch('get_forecast_data/' + fixed_name)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "ok") {
                        const container = document.createElement("div");
                        container.className = "forecast-card";
                        container.innerText = fixed_name;
                        container.innerHTML = fixed_name;

                        parent_div_forecast.appendChild(container);


                        const realTimestamps = data.timestamps_overlap;
                        const realPredictions = data.predictions_overlap;
                        const realValues = data.real_values;
                        const futureTimestamps = data.timestamps_future;
                        const futurePredictions = data.predictions_future;
                        const last7DaysStart = data.last7daysStart;
                        const last7DaysEnd = data.last7daysEnd;


                        const traceReal = {
                            x: realTimestamps,
                            y: realValues,
                            mode: "lines",
                            name: "Dades Reals",
                            line: {color: 'red', dash: 'dot'}
                        };
                        const tracePredReal = {
                            x: realTimestamps,
                            y: realPredictions,
                            mode: 'lines',
                            name: 'Predicció (part real)',
                            line: {color: 'green'}
                        };
                        const tracePredFuture = {
                            x: futureTimestamps,
                            y: futurePredictions,
                            mode: 'lines',
                            name: 'Predicció (futur)',
                            line: {color: 'orange', dash: 'dot'}
                        }
                        const layout = {
                            title: 'Predicció vs Dades Reals',
                            xaxis: {title: 'Temps', range:[last7DaysStart, last7DaysEnd]},
                            yaxis: {title: 'Consum (Kw)'},
                            autosize: true,
                            margin: {t: 40, r: 20, b: 50, l: 50},
                            height: 300,
                            dragmode: 'pan',
                            showlegend: false,
                        };

                        const config = {responsive: true};

                        Plotly.newPlot(container, [traceReal, tracePredReal, tracePredFuture], layout, config);

                    }
                });


        });

        fetch('get_scheduler_data')
            .then(response => response.json())
            .then(data => {

                console.log(data)

                const container = document.createElement("div");
                container.className = "scheduler-card";
                container.innerText = "Sonnen";

                parent_div_scheduler.appendChild(container);

                Plotly.newPlot(container, data.data, data.layout)
                // if(data.status === "ok") {
                //     const s_container = document.createElement("div");
                //     s_container.className = "scheduler-card";
                //     s_container.innerHTML = data.schedule_name;
                //     s_container.innerText = data.schedule_name;
                //
                //     parent_div_scheduler.appendChild(s_container);
                //
                //     const optimizedValues = data.schedule_values;
                //     const timestamps = data.timestamps;
                //
                //     console.log(data);
                //
                //     var scheduler_graph_data = [
                //         {
                //             x: timestamps,
                //             y: optimizedValues,
                //             type: 'scatter'
                //         }
                //     ];
                //
                //     const layout = {
                //             title: 'Planing diari',
                //             xaxis: {title: 'Hores'},
                //             yaxis: {title: 'Consum (Kw)'},
                //             autosize: true,
                //             margin: {t: 40, r: 20, b: 50, l: 50},
                //             height: 300,
                //             dragmode: 'pan',
                //             showlegend: false,
                //         };
                //     const config = {responsive: true};
                //
                //     Plotly.newPlot(s_container, scheduler_graph_data, layout, config);

                // }
            })
    }

    onLoadPage();

</script>

</html>