<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Control energètic eXIT</title>
    <link rel="stylesheet" href="resources/mainStyle.css">
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">
    <!--    <link rel="stylesheet" href="../resources/mainStyle.css">-->

    <!-- llibreria d'icontes per al navbar-->
    <script src="https://cdn.plot.ly/plotly-3.1.0.min.js" charset="utf-8"></script>
    <script src="https://kit.fontawesome.com/d259d5cefc.js" crossorigin="anonymous"></script>
</head>
<body>
<!--    NAVBAR     -->
% rebase('./www/base.html', title='Exitos')

<div class="container">
    <!--    PAGE NAME AND DATE  -->
    <div class="content-section">
        <h1>Optimització</h1>
        <h4>{{current_date}}</h4>
        <button id="test-optimization" onclick="TestOptimization()"><i style="font-size: medium; margin-bottom: 5px;" class="fa-solid fa-ghost"></i> Forçar Optimització</button>
        <button id="new-device-config" onclick="NewDeviceConfig()"><i style="font-size: medium; margin-bottom: 5px;" class="fa-solid fa-plus"></i> Nova Configuració de Dispositiu</button>
    </div>

    <!-- GRÀFICA OPTIMITZACIÓ -->
    <div id="scheduler-grid" class="scheduler-grid"> </div>

    <!--    PLANIFICACIÓ SONNEN  -->
    <div class="scheduler-container">
        <div class="optimization-graphs-container">
            <div>
                <br>
                <br>

                <!-- INFO DE L'OPTIMITZACIÓ ACTUAL -->
                <h3 style="margin-bottom: 5px;">Sonnenbatterie 79259</h3>

                <!--  On / Off switch  -->
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span class="label-text"> OFF </span>
                    <input type="checkbox" id="toggle" class="offscreen" onchange="ChangeOptimizationStatus()"/>
                    <label for="toggle" class="switch"></label>
                    <span class="label-text"> ON </span>
                </div>

                 <p><b>Dispositiu : </b> Lorem</p>
                 <p><b>Variables associades : </b> Lorem</p>
                 <p><b>Restriccions : </b> Lorem</p>

            </div>
        </div>
    </div>
</div>




<div id="new-optimization-modal" class="modal hidden">
    <!--  FORMULARI DINÀMIC PER CREAR UNA NOVA OPTIMITZACIÓ  -->
    <div class="modal-content">
        <h3 style="margin-bottom: 5px;">Nova Optimització</h3>

        <!--   DISPOSITIU     -->
        <label for="device-name">Dispositiu:</label>
        <select name="device-name" id="device-name">
            % for device in device_names:
            <option value="{{device}}">{{device}}</option>
            %end
        </select>

        <br>

        <!--   TIPUS DE DISPOSITIU     -->
        <label for="device-type">Tipus de dispositiu: </label>
        <select name="deviceType" id="device-type" onchange="UpdateRestrictions()"></select>

        <!--   RESTRICCIONS     -->
        <div id="restrictionsContainer"></div>

        <!--   VARIABLES ASSOCIADES     -->
        <label for="aux-vars">Variables Associades:</label>
        <select name="aux-vars" id="aux-vars" >
            <option value="Lorem Ipsum 1">Lorem ipsum 1</option>
            <option value="Lorem Ipsum 2">Lorem ipsum 2</option>
            <option value="Lorem Ipsum 3">Lorem ipsum 3</option>
            <option value="Lorem Ipsum 4">Lorem ipsum 4</option>
        </select>


        <div style="margin-top: 20px;">
            <button onclick="SubmitOptimization()"> Guardar </button>
            <button onclick="CloseModal()"> Cancel·lar </button>
        </div>
    </div>
</div>


</body>

<script>
    const device_types = {{!device_types}}

    function TestOptimization() {
        fetch('optimize')
            .then(response => response.text())
            .then(data => console.log("Optimization pressed"))
    }

    function onLoadPage(){
          const parent_div_scheduler = document.getElementById("scheduler-grid");
                  fetch('get_scheduler_data')
            .then(response => response.json())
            .then(data => {
                const container = document.createElement("div");
                container.className = "scheduler-card";
                parent_div_scheduler.appendChild(container);

                Plotly.newPlot(container, data.data, data.layout)
            })
    }

    function NewDeviceConfig(){
          const modal = document.getElementById('new-optimization-modal');
          modal.classList.remove('hidden');

          const select = document.getElementById('device-type');
          select.innerHTML = '';

          for (const type in device_types){
              const opt = document.createElement('option');
              opt.value = type;
              opt.textContent = device_types[type].nom;
              select.appendChild(opt);
          }
          UpdateRestrictions();
    }

    function UpdateRestrictions() {
        const type = document.getElementById('device-type').value;
        const restrictions = device_types[type].restriccions;
        const container = document.getElementById('restrictionsContainer');
        container.innerHTML = '';

        restrictions.forEach(restriction => {
            if(typeof restriction === 'object'){
                container.innerHTML += `
                <label>${restriction.nom}: </label>
                <input type="number"
                        name="${restriction.nom}"
                        min="${restriction.min ?? ''}"
                        max="${restriction.max ?? ''}"
                        step="${restriction.step ?? 'any'}" />
                <br>
                `;
            }
            else {
                container.innerHTML += `
                    <label>~${restriction}:</label>
                    <input type="number" name="${restriction}" step="any"/>
                    <br>
                `;
            }
        });
    }

    async function SubmitOptimization(){
        const name = document.getElementById('device-name').value;
        const type = document.getElementById('device-type').value;
        const vars = document.getElementById('aux-vars').value;
        const restrictionInputs = document.querySelectorAll('#restrictionsContainer input');

        const restrictions = {};
        console.log(restrictionInputs)
        restrictionInputs.forEach(inp => {
            restrictions[inp.name] = inp.value;
        });

        const data = {
            name,
            type,
            restrictions,
            vars: vars//.split(',').map(v => v.trim()).filter(v => v)
        };

        console.log(data);

        const res = await fetch('save_optimization_config',{
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.status === 'ok') {
          document.getElementById('new-optimization-modal').classList.add('hidden');
        }
        else {
          console.error(result.status);
        }
    }

    function CloseModal(){
          document.getElementById("new-optimization-modal").classList.add('hidden');
    }

    function ChangeOptimizationStatus(){
        console.log("ChangeOptimizationStatus");
        //TODO: encendre o apagar l'optimització automàtica del dispositiu.
    }

    onLoadPage();
</script>
</html>