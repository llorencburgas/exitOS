<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Control energ猫tic eXIT</title>
    <link rel="stylesheet" href="resources/mainStyle.css">
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">
    <!--    <link rel="stylesheet" href="../resources/mainStyle.css">-->

    <!-- llibreria d'icontes per al navbar-->
    <script src="https://cdn.plot.ly/plotly-3.1.0.min.js" charset="utf-8"></script>
    <script src="https://kit.fontawesome.com/d259d5cefc.js" crossorigin="anonymous"></script>
</head>
<body>
<!--    NAVBAR     -->
% rebase('./www/base.html', title='Exitos')

<div class="container">
    <!--    PAGE NAME AND DATE  -->
    <div class="content-section">
        <h1>Optimitzaci贸</h1>
        <h4>{{current_date}}</h4>
        <button id="test-optimization" onclick="TestOptimization()"><i style="font-size: medium; margin-bottom: 5px;" class="fa-solid fa-ghost"></i> For莽ar Optimitzaci贸</button>
        <button id="new-device-config" onclick="NewDeviceConfig()"><i style="font-size: medium; margin-bottom: 5px;" class="fa-solid fa-plus"></i> Nova Configuraci贸 de Dispositiu</button>
    </div>

    <!-- GRFICA OPTIMITZACI -->
    <div id="scheduler-grid" class="scheduler-grid"> </div>

    <!--    PLANIFICACI SONNEN  -->
    <div class="scheduler-container">
        <div class="optimization-graphs-container" id="optimization-graphs-container">
            <!-- AQUI ES POSEN LES CONFIGURACIONS GUARDADES -->
        </div>
    </div>
</div>




<div id="new-optimization-modal" class="modal hidden">
    <!--  FORMULARI DINMIC PER CREAR UNA NOVA OPTIMITZACI  -->
    <div class="modal-content">
        <span class="modal-close" onclick="CloseModal()"></span>
        <h2>Nova Configuraci贸 de Dispositiu</h2>

        <!--   TIPUS DE DISPOSITIU     -->
        <div class="new-config-section">
            <label for="device-type">Tipus de dispositiu: </label>
            <select name="deviceType" id="device-type" onchange="UpdateRestrictions()"></select>
        </div>

        <!--   DISPOSITIU     -->
        <div class="new-config-section">
            <label for="device-name">Dispositiu:</label>
            <select name="device-name" id="device-name" onchange="UpdateAssociatedVariables()"></select>
        </div>

        <!--   RESTRICCIONS     -->
        <div class="new-config-section" id="restrictionsContainer"></div>

        <!--   VARIABLES ASSOCIADES     -->
        <div class="vars-config-section" id="vars-config-section"></div>
<!--        <label for="aux-vars">Variables Disponibles:</label>-->
<!--        <select name="aux-vars" id="aux-vars" multiple size="5"></select>-->
<!--        <br>-->
<!--        <small> Pots mantenir premut <b>Ctrl</b> (Windows/Linux) o <b>Cmd</b> (Mac) per seleccionar m茅s duna variable.</small>-->


        <div style="margin-top: 20px;">
            <button onclick="SubmitOptimization()"> Guardar </button>
            <button onclick="CloseModal()"> Cancel路lar </button>
        </div>
    </div>
</div>


</body>

<script>
    const device_types = {{!device_types}}
    const device_entities = {{!device_entities}}

    function TestOptimization() {
        fetch('optimize')
            .then(response => response.text())
            .then(data => console.log("Optimization pressed"))
    }

    /**
     * Funci贸 que es crida en carregar la pgina.
     * Genera la grfica d'optimitzaci贸 i crida la funci贸 per a mostrar les configuracions guardades
     */
    function onLoadPage(){
        const parent_div_scheduler = document.getElementById("scheduler-grid");
        fetch('get_scheduler_data')
        .then(response => response.json())
        .then(data => {
            const container = document.createElement("div");
            container.className = "scheduler-card";
            parent_div_scheduler.appendChild(container);

            Plotly.newPlot(container, data.data, data.layout)
        })
        LoadConfigsSaved();
    }

    /**
     * Obre el formulari per a crear una nova configuraci贸 i l'omple dinmicament.
     */
    function NewDeviceConfig(){
          const modal = document.getElementById('new-optimization-modal');
          modal.classList.remove('hidden');

          const select = document.getElementById('device-type');
          select.innerHTML = '';

          for (const type in device_types){
              const opt = document.createElement('option');
              opt.value = type;
              opt.textContent = device_types[type].nom;
              select.appendChild(opt);
          }
          UpdateRestrictions();
          LoadDevicesEntities();
    }

    /**
     * Modifica les restriccions segons el tipus de device seleccionat al formulari
     */
    function UpdateRestrictions() {
        const type = document.getElementById('device-type').value;
        const restrictions = device_types[type].restriccions;
        const container = document.getElementById('restrictionsContainer');
        container.innerHTML = '';

        restrictions.forEach(restriction => {
            if(typeof restriction === 'object'){
                container.innerHTML += `
                <label>${restriction.nom}: </label>
                <input type="number"
                        name="${restriction.nom}"
                        min="${restriction.min ?? ''}"
                        max="${restriction.max ?? ''}"
                        step="${restriction.step ?? 'any'}" />
                <br>
                `;
            }
            else {
                container.innerHTML += `
                    <label>~${restriction}:</label>
                    <input type="number" name="${restriction}" step="any"/>
                    <br>
                `;
            }
        });
    }

    /**
     * Modifica els inputs per a les variables associades segons el tipus de dispositiu i entitats d'aquest
     */
    function UpdateAssociatedVariables(){
        const device_type = document.getElementById('device-type').value;
        const device_name = document.getElementById('device-name').value;
        let devices = {}

       if(Array.isArray(device_types)){
        device_types.forEach(item => {
            const [name, entities] = Object.entries(item)[0];
            devices[name] = entities;
        });
        }else{
            devices = device_entities;
        }


        const vars = device_types[device_type]["variables"];
        const container = document.getElementById('vars-config-section');
        container.innerHTML = '';

        vars.forEach(variable => {

            const label = document.createElement("label");
            label.for = variable;
            label.textContent = variable;
            label.id = "label-" + variable;

            const select = document.createElement("select");
            select.name = variable;
            select.id = variable;

            if (!device_name || !device_entities[device_name]) return;
            for (const ent of device_entities[device_name]) {
                const opt = document.createElement("option");
                opt.value = ent.entity_id;
                opt.textContent = ent.friendly_name;
                select.appendChild(opt);
            }

            container.appendChild(label);
            container.appendChild(select);
        })
    }

    /**
     * Retorna totes les variables seleccionades dins el div #vars-config-section.
     * Busca tots els <select> dins aquest div, i per a cadascun recull
     * totes les opcions seleccionades (amb id i friendly_name).
     *
     * @returns {Array<{id: string, friendly_name: string}>}
     */
    function GetSelectedVariables(){
        const container = document.getElementById("vars-config-section");
        const allSelects = container.querySelectorAll('select');

        const selectedVars = []

        allSelects.forEach(select => {

            const label = document.getElementById("label-" + select.id);
            const groupLabel = label ? label.textContent.trim() : "Sense nom";

            Array.from(select.selectedOptions).forEach(opt => {
                selectedVars.push({
                    id: opt.value,
                    friendly_name: opt.text,
                    function_name: groupLabel
                });
            })
        })
        return selectedVars;
    }

    /**
     * Envia les dades entrades al formulari a Back-end per guardar-les
     * @async
     * @returns {Promise<void>}  Si tot ha anat b茅 recarrega la pgina amb les configuracions noves.
     */
    async function SubmitOptimization(){

        const name = document.getElementById('device-name').value;
        const type = document.getElementById('device-type').value;
        const friendly_type = device_types[type].nom;
        const vars = GetSelectedVariables();
        const restrictionInputs = document.querySelectorAll('#restrictionsContainer input');

        const restrictions = {};
        restrictionInputs.forEach(inp => {
            restrictions[inp.name] = inp.value;
        });

        console.log(vars);

        const data = {
            name,
            type,
            friendly_type,
            restrictions,
            vars
        };

        const res = await fetch('save_optimization_config',{
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await res.json();
        if (result.status === 'ok') {
          document.getElementById('new-optimization-modal').classList.add('hidden');
          const parent_config_div = document.getElementById("optimization-graphs-container");
          parent_config_div.innerHTML = '';
          await LoadConfigsSaved();
        }
        else {
          console.error(result.status);
        }
    }

    /**
     * Tanca el formulari
     */
    function CloseModal(){
          document.getElementById("new-optimization-modal").classList.add('hidden');
    }

    /**
     * Omple els selects amb les variables concretes del dispositiu seleccionat
     */
    function LoadDevicesEntities(){
        let devices = {}

        if(Array.isArray(device_entities)){
            device_entities.forEach(item => {
                const [name, entities] = Object.entries(item)[0];
                devices[name] = entities;
            });
        }else{
            devices = device_entities;
        }

        const deviceSelect = document.getElementById('device-name');
        deviceSelect.innerHTML  = '<option value="">-- Selecciona un dispositiu --</option>';

        const sortedDevices = Object.keys(devices).sort((a, b) =>
                                a.localeCompare(b, 'ca', { sensitivity: 'base' }));

        for (const dev of sortedDevices){
            const opt = document.createElement('option');
            opt.value = dev;
            opt.textContent = dev;
            deviceSelect.appendChild(opt);
        }
    }

    /**
     * Carrega des del back-end les configuracions guardades
     * @returns {Promise<void>} Si les obt茅 correctament les mostra a la pgina.
     */
    async function LoadConfigsSaved(){
        let saved_configs = ""
        const res = await fetch('get_config_file_names', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await res.json();
        if (result.status === 'ok') {
            saved_configs = JSON.parse(JSON.stringify(result.names));
        }
        const parent_config_div = document.getElementById("optimization-graphs-container");

        saved_configs.forEach((config_name) => {
            fetch('get_device_config_data/' + config_name)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    // console.log(data["device_config"].vars[2]);
                    const dev = data["device_config"];

                    const container = document.createElement('div');
                    container.className = "device-config-container";

                    // NOM DEL DISPOSITIU
                    const name = document.createElement('h3');
                    name.className = "device-config-title";
                    name.textContent = dev.name;
                    container.appendChild(name);

                    // ON - OFF SWITCH

                    //TODO : switch

                    // TIPUS DE DISPOSITIU
                    const type = document.createElement('span');
                    type.innerHTML = '<b class="device-cofig-boltText">Dispositiu: </b>' + dev.friendly_type;
                    type.className = "device-config-type";
                    container.appendChild(type);

                    // RESTRICCIONS
                    const restricctions = document.createElement('ul');
                    restricctions.className = "device-config-ul";
                    restricctions.innerHTML = ' ';
                    for (const r in dev.restrictions) {
                        const restriction = document.createElement('li');
                        restriction.className = "device-config-li";
                        restriction.innerHTML = `<b class="device-config-boldText">${r}: </b> ${dev.restrictions[r]}`;
                        // restriction.innerHTML = r + ": " + dev.restrictions[r];
                        restricctions.appendChild(restriction);
                    }
                    container.appendChild(restricctions);

                    // VARIABLES (entitats)
                    const extra_vars = document.createElement('ul');
                    extra_vars.className = "device-config-ul"
                    extra_vars.innerHTML = '';
                    for (const r in dev.vars) {
                        const extra_var = document.createElement('li');
                        extra_var.className = "device-config-li";
                        extra_var.innerHTML = `<b class="device-config-boldText"> ${dev.vars[r].function_name}: </b> ${dev.vars[r].friendly_name}`;
                        extra_vars.appendChild(extra_var);
                    }
                    container.appendChild(extra_vars);

                    // BOT ELIMINAR
                    const delete_button = document.createElement('button');
                    delete_button.className = "device-config-delete-button";
                    delete_button.innerHTML = 'Eliminar Configuraci贸';
                    delete_button.onclick = async () => {
                        const res = await fetch('delete_optimization_config/' + config_name, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'}
                        });

                        const result = await res.json();
                        if (result.status === 'ok') {
                            parent_config_div.innerHTML = '';
                            await LoadConfigsSaved();
                        } else {
                            console.error(result.status);
                        }
                    }
                    container.appendChild(delete_button);

                    parent_config_div.appendChild(container);
                }

            })
        })

    }

    function ChangeOptimizationStatus(){
        console.log("ChangeOptimizationStatus");
        //TODO: encendre o apagar l'optimitzaci贸 automtica del dispositiu.
    }

    onLoadPage();
</script>
</html>