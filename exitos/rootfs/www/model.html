<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Control energètic eXIT</title>
    <link rel="stylesheet" href="resources/mainStyle.css">
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">
<!--    <link rel="stylesheet" href="../images/mainStyle.css">-->

        <!-- llibreria d'icontes per al navbar-->
    <script src="https://kit.fontawesome.com/d259d5cefc.js" crossorigin="anonymous"></script>
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>

    <style>
        h3{
            margin-top: 20px;
            margin-bottom: 10px;
        }
        #loadingSpinner{
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20%;
            height: 20%;
            text-align: center;
            z-index: 1000;
            background-color: #f1f1f1;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .spinner{
            border: 8px solid #f3f3f3;
            border-top: 8px solid #04AA6D;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingText{
            margin-top: 10px;
            font-size: 16px;
            color: #04AA6D;
        }
        form{
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        label{
            margin-bottom: 5px;
        }
        .container{
            display: flex;
            flex-direction: row;
            gap: 10px;
        }
        .content-section {
            flex: 1;
            padding: 20px;
            box-sizing: border-box;
        }

    </style>
</head>
<body>
    <main>
        <header>
            <nav class="nav">
                <div class="navbar-container">
                    <a href="https://exit.udg.edu/ca/" class="nav-image-link" target="_blank">
                        <img src="./static/exitlogo.png" alt="Exit research group logo">
                    </a>
                    <div class="nav-items">
                        <a href="./" class="nav-link"> <i class="fa-solid fa-house"></i>  Inici</a>
                        <a href="./sensors" class="nav-link"> <i class="fa-solid fa-square-check"></i> Sensors</a>
                        <a href="./databaseView" class="nav-link"> <i class="fa-solid fa-database"></i> Base de Dades</a>
                        <a href="./model" class="nav-link"> <i class="fa-solid fa-poo"></i> Crear Model</a>
                        <a href="./config_page" class="nav-link"> <i class="fa-solid fa-user-gear"></i> Configuració</a>
                    </div>
                </div>
            </nav>
        </header>


        <div class="container">
            <!--  CREAR EL MODEL  -->
            <div class="content-section">
                <h1> Creació del Model </h1>
                <p> Instruccions a seguir per l'usuari</p>

                <form action="./submit-model" method="POST" onsubmit="showLoadingSpinner()" >

                    <h3> 1. Selecciona el sensor objectiu</h3>
                    <select class="form-select" id="sensorsId" name="sensorsId" required  style="width: 50%;">
                        % for sensor in sensors_input:
                          <option value="{{sensor}}">{{sensor}}</option>
                        % end
                    </select>


                    <h3> 2. Selecciona variables extra</h3>
                     <p style="font-size: 14px; font-style: italic; margin-bottom: 5px;"> Opcional... </p>
                    <select class="form-select" id="extraSensorsId" name="extraSensorsId" multiple style="width: 100%; height:11vh;"
                            onchange="updateSelection('extraSensorsId','selectedSensorsId')">
                        <option value="None">None</option>
                        % for sensor in sensors_input:
                            <option value="{{sensor}}">{{sensor}}</option>
                        % end
                    </select>
                    <div id="selectedSensorsId" ></div>

                    <h3>3. Configura el model</h3>

                    <label for="model">Algorisme:
                        <select name="model" id="modelSelect">
                            <option value="AUTO">Automàtic</option>
                            <option value="SVR">Support Vector Regression (SVR)</option>
                            <option value="KNN">K-Nearest Neighbors (KNN)</option>
                            <option value="RF">Random Forest (RF)</option>
                            <option value="Dummy">Dummy</option>
                            <option value="PLS">Partial Least Squares (PLS)</option>
                            <option value="MLP">Multi-Layer Perceptron (MLP)</option>
                        </select>
                    </label>
                    <div id="modelConfig"></div>


                    <label for="scaled">Escalat
                        <select name="scaled" id="scaled">
                            <option value="None">None</option>
                            <option value="Standard">Standard</option>
                            <option value="Robust">Robust</option>
                            <option value="MINMAX">MINMAX</option>
                        </select>
                    </label>

                    <div>
                        <label for="meteoData">Dades Meteorològiques: </label>
                        <input type="checkbox" id="meteoData" name="meteoData" style="margin-left: 3px" value="false">
                    </div>


                    <h3 style="margin-bottom: 1px;">4. Introdueix un Nom al model </h3>
                    <p style="font-size: 14px; font-style: italic; margin-bottom: 5px;"> En cas de deixar en blanc el nom serà el del sensor objectiu.</p>

                    <label for="modelName">Nom del Model
                        <input type="text" name="modelName" id="modelName" placeholder="Nom del Model">
                    </label>

                    <button type="submit"><i style="font-size: medium" class="fa-solid fa-bolt"></i> Train</button>

                </form>

                <div id="loadingSpinner" style="display: none;">
                    <div class="spinner"></div>
                    <p id="loadingText">Processant Forecast. Això pot tardar uns minuts....</p>
                </div>
            </div>


            <div class="content-section" style="align-items: flex-start; padding-top: 20px;">
                <form action ="./submit-forecast" method="POST" id="forecast-form"
                      style="flex-direction: row; gap: 10px; align-items: flex-start; margin-bottom: 10px;">
                    <div><!--  FORECAST   -->
                        <h1>FORECAST</h1>
                        <h3> 1. Selecciona el model entrenat</h3>
                        <select class="form-select" id="models" name="models" required
                                onchange="updateSelection('models', 'selectedModel')">

                            <option class="formOption" value="none" disabled selected hidden>Escull Un Model</option>
                            % for model in models_input:
                              <option class="formOption" value="{{model}}">{{model}} {{'selected' if defined('selected_model') and model == selected_model else ''}}</option>
                            % end
                        </select>
                        <div id="selectedModel">  </div>

                        <button id="fetch-data" name="action" value="forecast" type="submit"><i style="font-size: medium" class="fa-solid fa-chart-line"></i> Realitzar Forecast </button>
                        <button id="delete-model" name="action" value="delete-model" type="submit"><i style="font-size: medium" class="fa-solid fa-trash-can"></i> Eliminar Model </button>
                    </div>

                    <div><!-- VISUALITZAR FORECAST  -->
                        <h1>Visualitzar Forecast</h1>
                        <h3>1. Selecciona el Forecast a Visualitzar</h3>

                        <select class ="form-select" id="forecasts" name="forecasts" required >
                            <option class="formOption" value="none" disabled selected hidden> Escull un Forecast</option>
                            %for forecast in forecasts_id:
                            <option class="formOption" value="{{forecast}}">{{forecast}} {{'selected' if defined('selected_forecast') and forecast == selected_forecast else ''}} </option>
                            %end
                        </select>
                        <div id="forecast-dates-div"></div>
                        <button id="view-forecast" name="action" value="view" type="submit"><i style="font-size: medium" class="fa-solid fa-eye"></i> Visualitzar Forecast </button>
                        <button id="delete-forecast" name="action" value="delete-forecast" type="submit"><i style="font-size: medium" class="fa-solid fa-trash-can"></i> Eliminar Forecast </button>
                    </div>
                </form>


                %if has_graph:
                    <h2>Resultats del Forecast per al model: {{model}}</h2>
                    <div id="chart"></div>
                    <script>
                        const timestamps = {{!timestamps}};
                        const predictions = {{!predictions}};
                        const realValues = {{!real_values}};

                        const tracePrediction = {
                            x: timestamps,
                            y: predictions,
                            mode: 'lines+markers',
                            name: 'Predicció',
                            line: { color: 'green' }
                        };

                        const traceReal = {
                            x: timestamps,
                            y: realValues,
                            mode: 'lines+markers',
                            name: 'Dades Reals',
                            line: {
                                color: 'red',
                                dash: 'dot'  // Dotted line
                            }
                        };

                        const layout = {
                            title: 'Predicció vs Dades Reals',
                            xaxis: { title: 'Temps' },
                            yaxis: { title: 'Consum (kW)' }
                        };

                        Plotly.newPlot('chart', [tracePrediction, traceReal], layout);
                    </script>
                %end

            </div>
        </div>

        <footer class="footer">
            <p>Created by: Grup Exit | Copyright &copy; 2024</p>
            <p><a href="mailto:comunitatenergeticaexit@gmail.com" class="mail-text">comunitatenergeticaexit@gmail.com</a></p>
        </footer>
    </main>

<script>

    function showLoadingSpinner(){
        document.getElementById('loadingSpinner').style.display = 'block';
    }

    function updateSelection(selectId, displayId){
        const selectElement= document.getElementById(selectId);
        if(selectElement.value != "none"){
            const selectedOptions = Array.from(selectElement.selectedOptions).map(option => option.value);
            document.getElementById(displayId).innerHTML = selectedOptions.length ? selectedOptions.join(', ') : 'Null Selection';
        }
    }

    const modelConfigs = {
        "SVR": {
            "kernel": ["linear", "rbf", "poly"],
            "C": [0.01, 0.1, 1, 10, 100, 1000],
            "degree": [2, 3, 4, 5],
            "max_iter": [100000, null],
            "gamma": ["scale", "auto"]
        },
        "KNN":{
            "n_neighbors": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
            "algorithm": ["auto", "ball_tree", "kd_tree", "brute"],
            "weights": ["uniform", "distance"]
        },
        "RF": {
            "n_estimators": [200, 266, 333, 400, 466, 533, 600, 666, 733, 800],
            "max_features": ["sqrt", "log2", null],
            "max_depth": [100, 422, 744, 1066, 1388, 1711, 2033, 2355, 2677, 3000, null],
            "min_samples_split": [2, 5, 10],
            "min_samples_leaf": [1, 2, 4],
            "bootstrap": [true, false]
        },
        "Dummy": {
            "strategy": ["mean", "median", "constant"],
            "quantile": [0.25, 0.75],
            "constant": [0]
        },
        "PLS": {
            "n_components": [1, 2, 3, 4, 5, 6],
            "scale": [true, false],
            "max_iter": [200, 300, 400, 500, 600, 700, 800, 900, 1000]
        },
        "MLP": {
            "hidden_layer_sizes": [50, 75, 100, 150, 200, 250, 300, 350],
            "activation": ["identity", "logistic", "tanh", "relu"],
            "solver": ["lbfgs", "sgd", "adam"],
            "learning_rate": ["constant", "invscaling", "adaptive"]
        },
        "AUTO":{
            "max_time": [30, 60, 100, 300, 600, 1200]
        }
    };

    function updateModelConfig(savedParams = null){
        const selectedModel = document.getElementById('modelSelect').value;
        const configDiv = document.getElementById('modelConfig');
        configDiv.innerHTML = '';

        if(modelConfigs[selectedModel]){
            Object.keys(modelConfigs[selectedModel]).forEach(key => {
                let label = document.createElement('label');
                label.innerText = key + ": ";
                configDiv.appendChild(label);

                let select = document.createElement('select');
                select.name = key;

                modelConfigs[selectedModel][key].forEach(option => {
                    let optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.innerText = option === null ? 'Null' : option;

                    if(savedParams && savedParams[key] === option){
                        optionElement.selected = true;
                    }

                    select.appendChild(optionElement);
                });

                configDiv.appendChild(select);
                configDiv.appendChild(document.createElement('br'));
            });
        }
    }

    function updateModelSelection(modelPath){
     fetch('get_model_config/' + modelPath)
        .then(response => response.text())
        .then(data => {
            const lines = data.split('\n');
            const config = {};

            lines.forEach(line => {
                const [key, value] = line.split("=");
                if (key && value !== undefined) {
                    config[key.trim()] = value.trim();
                }
            });

            document.getElementById("modelSelect").value = config["algorithm"];
            document.getElementById("scaled").value = config["scaler"];
            document.getElementById("modelName").value = modelPath;

            updateModelConfig(config);
            for (const [key, value] of Object.entries(config)) {
                const select = document.querySelector(`select[name="${key}"]`);
                if (select) {
                    select.value = value;
                }
            }

            // Fill sensors (if single select, just select it)
            const sensorSelect = document.getElementById("sensorsId");
            const sensorOptions = Array.from(sensorSelect.options);
            sensorOptions.forEach(opt => {
                opt.selected = config["sensorsId"] && config["sensorsId"].includes(opt.value);
            });
            updateSelection("sensorsId", "selectedSensorsId");
        });
    }

    function updateForecastSelector(forecast_id){
        fetch('get_forecasts/' + forecast_id)
            .then(response => response.text())
            .then(data => {
                const lines = data.split('\n').map(line => line.trim()).filter(line => line !== '');
                const forecastDiv = document.getElementById('forecast-dates-div');

                forecastDiv.innerHTML = '';

                if(lines.length === 0 || (lines.length === 1 && lines[0] === '')){
                    forecastDiv.innerHTML = '<p> No hi ha dades per aquest forecast. </p>';
                }
                else{
                    const label = document.createElement('h3');
                    const selectedTime = "{{selected_time if defined('selected_time') else ''}}";
                    label.textContent = '2. Selecciona la data del Forecast';

                    const select = document.createElement('select');
                    select.className = 'form-select';
                    select.name = 'forecasts-time';
                    select.id = 'forecasts-time';
                    select.required = true;

                    //default option
                    const defaultOption = document.createElement('option');
                    defaultOption.className = 'formOption';
                    defaultOption.value = 'none';
                    defaultOption.disabled = true;
                    if (!selectedTime){ defaultOption.selected = true; }
                    defaultOption.hidden = true;
                    defaultOption.textContent = 'Escull una Data';
                    select.appendChild(defaultOption);

                    //Opcions per a les dates
                    lines.forEach(date => {
                        const option = document.createElement('option');
                        option.className = 'formOption';
                        option.value = date;
                        option.textContent = date;

                        if (date === selectedTime){
                            option.selected = true;
                        }

                        select.appendChild(option);
                    });

                    forecastDiv.appendChild(label);
                    forecastDiv.appendChild(select);
                }


            })
    }

    document.getElementById('modelSelect').addEventListener('change', updateModelConfig);
    updateModelConfig();

    document.getElementById('models').addEventListener('change', function() {
        const selectedModel = this.value;
        if(selectedModel.value !== "none"){
            const modelPath = selectedModel.replace(".pkl", "")
            updateModelSelection(modelPath)
        }
    })

    document.getElementById('forecasts').addEventListener('change', function(){
        const selected_forecast_id = this.value;
        if(selected_forecast_id.value !== 'none'){
            updateForecastSelector(selected_forecast_id);
        }
    });





</script>

</body>
</html>