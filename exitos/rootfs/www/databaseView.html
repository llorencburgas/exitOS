<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <title>Control energètic eXIT</title>
    <link rel="stylesheet" href="resources/mainStyle.css">
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">

    <!-- llibreria d'icones per al navbar-->
    <script src="https://kit.fontawesome.com/d259d5cefc.js" crossorigin="anonymous"></script>
    <!--  PLOTLY: gràfiques  -->
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>
    <!--  jQuery, Moments.js, Date Range Picker Files  -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"/>

</head>
<body>
    <!--    NAVBAR     -->
    % rebase('./www/base.html', title='Exitos')


    <div class="container">
        <div class="content-section">
            <form action="./graphsView" method="POST" id="graphs-form">
                <h1>Visualitzador de Dades</h1>

                <h2 style="margin-top: 20px;">Data a mostrar:</h2>

                <input class="database-date-input" type="text" name="datetimes"/>

                <div id="sensor-data" data-sensors="{{sensors_id}}"></div>

                <div class="sensor-container">
                    <h2>Sensors a mostrar:</h2>
                    <div class="tag-container" id="selected-sensors"></div>

                    <div class="dropdown">
                        <input type="text" class="search-box" id="sensor-search"
                               placeholder="Cerca i selecciona sensors...">
                        <ul class="sensor-list" id="sensor-list"></ul>
                    </div>
                </div>

                <!-- Hidden Input per guardar els sensors seleccionats -->
                <input type="hidden" name="sensors_id" id="sensors-input" value="">

            </form>
            <button class="btn" id="fetch-data" onclick="FetchGraph()"><i class="fa-solid fa-chart-line"></i> Mostrar Gràfiques</button>
            <button class="btn secondary" id="update-database" onclick="UpdateDatabase()" style="margin-bottom: 100px;"><i class="fa-solid fa-arrows-rotate"></i> Actualitzar Base de Dades</button>
            <button class="btn self-destruct" id="delete-database" onclick="OpenModal()" style="margin-bottom: 30px;"><i class="fa-solid fa-ban"></i> Eliminar Base de Dades </button>

            % for sensor_id, graph_html in graphs.items():
            <h2>Sensor {{ sensor_id }}</h2>
            <div>{{!graph_html}}</div>
            % end

            <div id="graph-container"></div>
        </div>
    </div>




    <div id="self-destruct-modal" class="modal hidden">
        <div id="modal-box" class="modal-content">
            <h2 id="modal-title">SELF DESTRUCT</h2>
            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 12px;">
                <p id="modal-text" style="justify-content: center">Estàs a punt d'eliminar tota la Base de Dades!!</p>
            </div>

            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 12px;">
                <button class="btn self-destruct" id="btn-yes"> Eliminar </button>
                <button class="btn secondary" id="btn-no"> Cancel·lar </button>
            </div>

            <div id="explosion-container" class="explosion"></div>
        </div>
    </div>


</body>

<script>
    //#region select sensors
    let sensors = document.getElementById("sensor-data").getAttribute("data-sensors").split(",");
    sensors = sensors.map(sensor => sensor.replace(/['\[\]]/g, ''));


    const selectedSensors = new Set();
    const sensorSearch = document.getElementById("sensor-search");
    const sensorList = document.getElementById("sensor-list");
    const selectedSensorsContainer = document.getElementById("selected-sensors");
    const sensorsInput = document.getElementById("sensors-input");

    //Funció per actualitzar el hidden input field
    function updateSensorsHiddenInput() {
        sensorsInput.value = Array.from(selectedSensors).join(",");
    }

    //Funció per actualitzar els sensors del Dropdown
    function updateSensorList(filteredSensors) {
        sensorList.innerHTML = "";
        if (filteredSensors.length > 0) {
            sensorList.style.display = "block";
            filteredSensors.forEach(sensor => {
                const li = document.createElement("li");
                li.textContent = sensor;
                li.onclick = () => selectSensor(sensor);
                sensorList.appendChild(li);
            });
        } else {
            sensorList.style.display = "none";
        }
    }

    //Mostra la llista completa de sensors
    sensorSearch.addEventListener("focus", () => {
        updateSensorList(sensors);
    });

    //Filtra dinamicament mentre s'escriu
    sensorSearch.addEventListener("input", () => {
        const query = sensorSearch.value.toLowerCase();
        const filteredSensors = sensors.filter(sensor => sensor.toLowerCase().includes(query));
        updateSensorList(filteredSensors);
    });

    //selecciona sensor i afageix com a tag
    function selectSensor(sensor) {
        if (!selectedSensors.has(sensor)) {
            selectedSensors.add(sensor);

            const tag = document.createElement("div");
            tag.className = "tag";
            tag.innerHTML = `${sensor} <span class="remove" onclick="removeSensor(event, '${sensor}')">&times;</span>`;
            tag.setAttribute("data-sensor", sensor);
            selectedSensorsContainer.appendChild(tag);

            updateSensorsHiddenInput()
        }

        sensorSearch.value = "";
        sensorList.style.display = "none";
    }

    //Eliminar tag de sensor
    function removeSensor(event, sensor) {
        selectedSensors.delete(sensor);

        //elimina només el sensor clicat
        event.target.parentElement.remove();
        updateSensorsHiddenInput()
    }

    //amaga la llista al fer clic a fora
    document.addEventListener("click", (event) => {
        if (!event.target.closest(".dropdown")) {
            sensorList.style.display = "none";
        }
    });

    //#endregion select sensors

    //#region graph generation
    function FetchGraph() {

        const sensors = document.getElementById("sensors-input").value;
        const datetimesInput = document.querySelector('input[name="datetimes"]');
        console.log("Datetime input" + datetimesInput);


        const formData = new URLSearchParams();
        formData.append('sensors_id', sensors);
        if (datetimesInput.value != "") {
            const datetimes = datetimesInput.value.trim();
            console.log("datetimes trim" + datetimes);
            formData.append('datetimes', datetimes);
        }

        fetch('get_graph_info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: formData.toString()
        })
            .then(response => response.json())
            .then(data => {
                const graphContainer = document.getElementById("graph-container");
                graphContainer.innerHTML = "";
                graphContainer.style.width = "100%";

                Object.entries(data.graphs).forEach(([sensorId, graph]) => {
                    const h2 = document.createElement("h2");
                    h2.textContent = sensorId;
                    graphContainer.appendChild(h2);

                    const container = document.createElement("div");
                    graphContainer.appendChild(container);

                    const trace = {
                        x: graph.timestamps,
                        y: graph.values,
                        mode: 'lines',
                        name: 'sensorId',
                        line: {color: 'green'}
                    }
                    const layout = PlotlyTheme.mergeLayout({
                        xaxis: {title: 'Timestamp'},
                        yaxis: {title: 'Value'},
                        dragmode: 'pan'
                    });

                    Plotly.newPlot(container, [trace], layout, { responsive: true });
                });
            });
    }

    function UpdateDatabase(){
        fetch('force_update_database')
            .then(response => response.text())
            .then(data => console.log("Database updated"))
    }

    //#endregion graph generation

    //#region SELF DESTRUCT BUTTON

    const modal = document.getElementById("self-destruct-modal");
    const modalBox = document.getElementById("modal-box");
    const modalTitle = document.getElementById("modal-title");
    const modalText = document.getElementById("modal-text");

    let selfDestructCounter = 3;

    function resetAnimations() {
        modalBox.style.animation = "none";
        modalBox.offsetHeight;
        modalBox.style.animation = "";
    }

    function OpenModal() {
        modal.classList.remove("hidden");
        resetAnimations();
        modalBox.classList.add("opening");
    }

    function AnimateStepChange(newTitle, newText) {
        resetAnimations();
        modalBox.classList.add("closing");

        setTimeout(() => {
            // Canvi de text DURANT el "punt mort"
            modalTitle.textContent = newTitle;
            modalText.textContent = newText;

            modalBox.classList.remove("closing");
            resetAnimations();
            modalBox.classList.add("opening");

        }, 250); // coincideix amb duració closing
    }

    function triggerExplosion(x, y) {
        const sparks = 25;

        for (let i = 0; i < sparks; i++) {
            const spark = document.createElement("div");
            spark.classList.add("spark");

            // posició inicial (al centre del modal)
            spark.style.left = `${x}px`;
            spark.style.top = `${y}px`;

            // direcció aleatòria
            const angle = Math.random() * Math.PI * 2;
            const distance = 120 + Math.random() * 80;

            spark.style.setProperty("--sx", `${Math.cos(angle) * distance}px`);
            spark.style.setProperty("--sy", `${Math.sin(angle) * distance}px`);

            document.body.appendChild(spark);

            // eliminar després de l'animació
            setTimeout(() => spark.remove(), 700);
        }
    }

    function ResetTextSelfDestruct(){
        selfDestructCounter = 3;
        modalTitle.textContent = "SELF DESTRUCT";
        modalText.textContent = "Estàs a punt d'eliminar tota la Base de Dades!!";
    }

    function DestroyModal() {

        // 1. Explosió al centre del modal
        const rect = modalBox.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        triggerExplosion(centerX, centerY);

        // 2. Animació de destrucció (sacsejada + flash)
        modalBox.classList.add("destroying");

        // 3. Espera que acabi l'animació (800ms)
        setTimeout(() => {
            // Amaga el modal després de destruir-lo
            modal.classList.add("hidden");
            modalBox.classList.remove("destroying");

            // Reset
            ResetTextSelfDestruct();

            SelfDestructBackend();

        }, 800);
    }

    async function SelfDestructBackend(){
        console.log("AAAAAAA")
        const res = await fetch('self_destruct', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const result = await res.json();
        if (result.status === 'ok') {
            console.log("EEEEEEEEE");
        }
    }


    document.getElementById("btn-yes").addEventListener("click", () => {
        selfDestructCounter--;

        if (selfDestructCounter === 2) {
            AnimateStepChange(
                "Estàs segur del que estàs a punt de fer?",
                "3"
            );
        }
        else if (selfDestructCounter === 1) {
            AnimateStepChange(
                "No la podràs recuperar! Ho saps, no?",
                "2"
            );
        }
        else if (selfDestructCounter === 0) {
            AnimateStepChange(
                "Encara ets a temps...",
                "1"
            );
        }
        else{
            setTimeout(() => {
                DestroyModal();
            }, 300);
        }
    });


    document.getElementById("btn-no").addEventListener("click", () => {
        modal.classList.add("hidden");
        ResetTextSelfDestruct();
    });


    //#endregion

    $(function () {
        $('input[name="datetimes"]').daterangepicker({
            timePicker: true,
            timePicker24Hour: true,
            timePickerIncrement: 1,
            autoUpdateInput: false,
            startDate: moment().startOf('hour'),
            endDate: moment().startOf('hour').add(24, 'hour'),
            showDropdowns: true,
            locale: {
                format: 'M/DD hh:mm A',
                separator: " - ",
                applyLabel: 'Aplicar',
                cancelLabel: "Cancel·lar",
                daysOfWeek: ["Di", "Dl", "Dt", "Dc", "Dj", "Dv", "Ds"],
                monthNames: ["Gen", "Feb", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Oct", "Nov", "Des"],
                firstDay: 1
            },
            ranges: {
                'Últims 7 Dies': [moment().subtract(6, 'days'), moment()],
                'Últims 30 dies': [moment().subtract(29, 'days'), moment()],
                'Aquest Mes': [moment().startOf('month'), moment().endOf('month')],
                'Mes Passat': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            },
            alwaysShowCalendars: true,
        }, function (start, end, label) {
            $('input[name="datetimes"]').val(start.format('DD/MM/YYYY HH:mm') + ' - ' + end.format('DD/MM/YYYY HH:mm'));
        });
    });
</script>
</html>